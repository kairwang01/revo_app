<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#43CD80">
  <title>Revo - revelotion promised Marketplace</title>
  
  <link rel="stylesheet" href="./assets/css/tokens.css">
  <link rel="stylesheet" href="./assets/css/base.css">
  <link rel="stylesheet" href="./assets/css/layout.css">
  <link rel="stylesheet" href="./assets/css/components.css">
  <link rel="stylesheet" href="./assets/css/pages.css">
  
  <link rel="icon" type="image/svg+xml" href="./favicon.svg">
  
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GBQT4SDBKZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GBQT4SDBKZ');
</script>
<body>
  <!-- homepage skeleton, slightly caffeinated -->
  <!-- Icon Sprite -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none" id="icon-sprite">
    <symbol id="icon-home" viewBox="0 0 24 24">
      <path d="M3 11.2 12 4l9 7.2V21a1 1 0 0 1-1 1h-5.5v-6h-5v6H4a1 1 0 0 1-1-1z"/>
    </symbol>
    <symbol id="icon-star" viewBox="0 0 24 24">
      <path d="M12 3.3 14.9 9l6.1.5-4.6 3.9 1.4 6L12 16.8 6.2 19.4l1.4-6-4.6-3.9 6.1-.5z"/>
    </symbol>
    <symbol id="icon-cart" viewBox="0 0 24 24">
      <path d="M4 5H2v2h2l2.4 9.3a2 2 0 0 0 2 1.5h8.4a2 2 0 0 0 1.9-1.4L20 9H7.1zM9 21.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm7 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
    </symbol>
    <symbol id="icon-user" viewBox="0 0 24 24">
      <path d="M12 3.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9zM4.5 19.6c0-3.1 3.3-5 7.5-5s7.5 1.9 7.5 5V21H4.5z"/>
    </symbol>
    <symbol id="icon-search" viewBox="0 0 24 24">
      <path d="M10.5 4a6.5 6.5 0 0 1 5.2 10.4l4.1 3.9-1.8 1.8-4-4.1A6.5 6.5 0 1 1 10.5 4zm0 2.4a4.1 4.1 0 1 0 .1 8.2 4.1 4.1 0 0 0-.1-8.2z"/>
    </symbol>
    <symbol id="icon-chevron-right" viewBox="0 0 24 24">
      <path d="M9 4 7.6 5.4 13.2 11l-5.6 5.6L9 18l7-7z"/>
    </symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24">
      <path d="M11 5h2v6h6v2h-6v6h-2v-6H5v-2h6z"/>
    </symbol>
    <symbol id="icon-location" viewBox="0 0 24 24">
      <path d="M12 3.5a6.5 6.5 0 0 1 6.5 6.5c0 4.2-4.4 9-6 10.7a.7.7 0 0 1-1 0c-1.6-1.7-6-6.5-6-10.7A6.5 6.5 0 0 1 12 3.5zm0 3a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7z"/>
    </symbol>
    <symbol id="icon-leaf" viewBox="0 0 24 24">
      <path d="M20.5 3.5S11 3 6.7 7.3C4.6 9.5 4 12.4 4 15.1 4 18 6 21 9.8 21c4.8 0 7-4.2 7-7.4 0-2.6-1.6-3.9-1.6-3.9s-1.4 2.2-4.3 3.1c-1.3.4-2.8.4-4 .3 0 0 1.4-.9 2.5-1.8 1.7-1.3 4.6-2.9 11.1-7.8z"/>
    </symbol>
    <symbol id="icon-bag" viewBox="0 0 24 24">
      <path d="M7 8V7.2C7 4.9 8.8 3 11.1 3h1.8C15.2 3 17 4.9 17 7.2V8h2.2A1.8 1.8 0 0 1 21 9.8v9.4A1.8 1.8 0 0 1 19.2 21H4.8A1.8 1.8 0 0 1 3 19.2V9.8A1.8 1.8 0 0 1 4.8 8H7zm2-.8c0-1 .8-1.9 2.1-1.9h.8c1.3 0 2.1.9 2.1 1.9V8H9z"/>
    </symbol>
  </svg>

  <!-- Header -->
  <header class="app-header">
    <div class="header-left">
      <div class="dropdown" id="city-dropdown">
        <button class="dropdown-toggle" id="city-toggle">
          <svg width="20" height="20"><use href="#icon-location"></use></svg>
          <span id="selected-city">Ottawa</span>
        </button>
        <div class="dropdown-menu hidden" id="city-menu">
          <div class="dropdown-item" data-city="Vancouver">Vancouver</div>
          <div class="dropdown-item" data-city="Edmonton">Edmonton</div>
          <div class="dropdown-item" data-city="Ottawa">Ottawa</div>
        </div>
      </div>
    </div>
    
    <div class="header-center">
      <div class="search-bar">
        <svg class="search-icon" width="20" height="20"><use href="#icon-search"></use></svg>
        <input type="text" class="search-input" placeholder="Search products..." id="search-input">
      </div>
    </div>
    
    <div class="header-right">
      <a href="./cart.html" class="icon-btn">
        <svg><use href="#icon-cart"></use></svg>
        <span class="sr-only">Cart</span>
      </a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="page-wrapper">
    <div class="container">
      <!-- Hero Banner -->
      <section class="home-hero">
        <div class="banner" onclick="location.href='./products.html'">
          <div class="banner-title">Voucher Boost $299.99 CAD</div>
          <div class="banner-subtitle">Limited time offer on all refurbished devices</div>
        </div>
      </section>

      <!-- Categories -->
      <section>
        <div class="category-strip" id="categories">
          <!-- Categories will be loaded dynamically -->
        </div>
      </section>

      <!-- My Items -->
      <section class="home-section">
        <header>
          <h2>My Items</h2>
          <a href="./account.html" class="btn btn-ghost btn-sm">Account</a>
        </header>
        <div id="my-items-content">
          <p class="text-muted">Sign in to track the devices you trade and purchase.</p>
          <a href="./login.html" class="btn btn-primary btn-sm" style="margin-top: 1rem;">Sign in now</a>
        </div>
      </section>

      <!-- Deals Center -->
      <section class="home-section">
        <header>
          <h2>Deals Center</h2>
          <span class="chip">
            +20% Bonus
            <svg width="16" height="16"><use href="#icon-star"></use></svg>
          </span>
        </header>
        <div class="stack" id="deals-content">
          <div class="loader-container">
            <div class="spinner"></div>
          </div>
        </div>
      </section>

      <!-- Trending Curations -->
      <section class="home-section">
        <header>
          <h2>Trending Curations</h2>
        </header>
        <div class="product-grid" id="curated-grid">
          <div class="loader-container">
            <div class="spinner"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Chat Launcher -->
  <button class="chat-launcher" id="chat-launcher" aria-label="Open chat assistant">
    Chat
  </button>

  <!-- Chat Popup -->
  <div class="chat-widget" id="chat-widget" aria-hidden="true">
    <div class="chat-widget-header">
      <div>
        <p class="text-muted" style="margin: 0;">Need help?</p>
        <strong>Chat with Revo</strong>
      </div>
      <button class="chat-close" id="chat-close" aria-label="Close chat">Ã—</button>
    </div>
    <div class="chat-widget-body">
      <iframe
        allow="microphone;"
        src="https://console.dialogflow.com/api-client/demo/embedded/9885ee5e-4983-440a-8fb9-f035a9193ea6"
        title="Revo AI assistant"
        loading="lazy">
      </iframe>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-tabbar">
    <a href="./index.html" class="tab-item active">
      <svg><use href="#icon-home"></use></svg>
      <span>Home</span>
    </a>
    <a href="./products.html" class="tab-item">
      <svg><use href="#icon-star"></use></svg>
      <span>Curated</span>
    </a>
    <div class="tab-item" style="opacity: 0; pointer-events: none;">
      <!-- Spacer for FAB -->
    </div>
    <a href="./sell.html" class="tab-item">
      <svg><use href="#icon-leaf"></use></svg>
      <span>Recycle</span>
    </a>
    <a href="./account.html" class="tab-item">
      <svg><use href="#icon-user"></use></svg>
      <span>Account</span>
    </a>
  </nav>

  <!-- FAB -->
  <a href="./sell.html" class="fab" title="Trade-In Estimate">
    <svg><use href="#icon-plus"></use></svg>
    <span class="sr-only">Trade-In</span>
  </a>

  <!-- Core Scripts -->
  <script src="./assets/js/storage.js"></script>
  
  <!-- API Integration (order matters!) -->
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/backendApi.js"></script>
  <script src="./assets/js/api.js"></script>
  
  <!-- UI and Page Scripts -->
  <script src="./assets/js/ui.js"></script>
  <script src="./assets/js/pages/home.js"></script>
  <script src="./assets/js/main.js"></script>
  
  <!-- Geolocation integration -->
  <script type="module">
    import { initCitySelection, setCity, getCity, REVO_CITIES } from "./assets/js/geo.js";

    const cityToggle = document.getElementById('city-toggle');
    const selectedCitySpan = document.getElementById('selected-city');
    const cityMenu = document.getElementById('city-menu');

    function renderCity() {
      const c = getCity();
      if (selectedCitySpan && c) {
        selectedCitySpan.textContent = c.name;
      }
    }

    // Listen for city changes
    // listen for city updates from anywhere
    window.addEventListener("revo:city-changed", renderCity);

    // On first load try to auto-select; if not, go to Choose City
    initCitySelection().then(city => {
      if (!city) {
        // No permission or error: redirect to Choose City page
        window.location.href = "./choose-city.html?from=index";
      } else {
        renderCity();
      }
    });

    // Update city dropdown to use new city list
    if (cityMenu) {
      cityMenu.innerHTML = '';
      REVO_CITIES.forEach(c => {
        const div = document.createElement('div');
        div.className = 'dropdown-item';
        div.dataset.city = c.key;
        div.textContent = c.name;
        div.addEventListener('click', (e) => {
          e.stopPropagation();
          setCity(c.key);
          renderCity();
          cityMenu.classList.add('hidden');
        });
        cityMenu.appendChild(div);
      });
    }

    // Allow manual change - go to choose city page
    if (cityToggle) {
      cityToggle.addEventListener('dblclick', (e) => {
        e.preventDefault();
        window.location.href = "./choose-city.html?from=index";
      });
    }

    // Chat widget toggle
    const chatLauncher = document.getElementById('chat-launcher');
    const chatWidget = document.getElementById('chat-widget');
    const chatClose = document.getElementById('chat-close');

    // tiny brain: two states, open or nope
    const closeChat = () => {
      chatWidget?.classList.remove('is-open');
      chatWidget?.setAttribute('aria-hidden', 'true');
      chatLauncher?.classList.remove('is-active');
    };

    // open sesame (pls work)
    const openChat = () => {
      chatWidget?.classList.add('is-open');
      chatWidget?.setAttribute('aria-hidden', 'false');
      chatLauncher?.classList.add('is-active');
    };

    if (chatLauncher && chatWidget && chatClose) {
      chatLauncher.addEventListener('click', () => {
        // toggle brain: if open close, if closed open. yup.
        if (chatWidget.classList.contains('is-open')) {
          closeChat();
        } else {
          openChat();
        }
      });

      chatClose.addEventListener('click', closeChat);

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeChat();
        }
      });
    }
  </script>
  
  <script src="./assets/js/support.js"></script>
</body>
</html>
